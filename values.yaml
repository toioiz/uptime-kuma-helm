# =============================================================================
# Uptime Kuma — Production Values
# Docker Hardened Images (dhi.io) by default.
# =============================================================================

# -- Number of Uptime Kuma replicas. Must be 1 (Uptime Kuma is not horizontally scalable).
replicaCount: 1

image:
  repository: dhi.io/uptime-kuma
  # -- Image tag. Pinned to a specific version for production stability.
  tag: "2.1.3"
  pullPolicy: IfNotPresent

# -- Optionally specify imagePullSecrets for private registries (e.g. dhi.io credentials).
# imagePullSecrets:
#   - name: dhi-registry-secret
imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

# =============================================================================
# Uptime Kuma Application Config
# =============================================================================
uptimeKuma:
  # -- Timezone for the application container.
  timezone: "UTC"
  # -- Data directory inside the container.
  dataDir: "/app/data"

# =============================================================================
# MySQL Backend (default: enabled)
# Uses dhi.io/mysql — Docker Hardened Image.
# =============================================================================
mysql:
  enabled: true

  image:
    repository: dhi.io/mysql
    tag: "8.4"
    pullPolicy: IfNotPresent

  auth:
    # -- MySQL root password. If left empty, a random 32-character password is
    # generated on first install and preserved across upgrades via secret lookup.
    # To set explicitly: --set mysql.auth.rootPassword=mysecret
    rootPassword: ""
    database: "uptimekuma"
    username: "uptimekuma"
    # -- MySQL app password. If left empty, a random 32-character password is
    # generated on first install and kept in sync with db-password automatically.
    # To set explicitly: --set mysql.auth.password=mysecret
    password: ""
    # -- Name of an existing Secret with keys: mysql-root-password, mysql-password.
    # When set, disables auto-generation entirely.
    existingSecret: ""

  # -- dhi.io/mysql uses a direct mysqld entrypoint and does NOT accept --flag style args.
  # Configuration is handled via the my.cnf ConfigMap below (mysql.config).
  # Leave args empty unless you know the image entrypoint supports them.
  args: []

  # -- MySQL configuration mounted as /etc/mysql/conf.d/custom.cnf inside the container.
  # bind-address=0.0.0.0 is required: dhi.io/mysql defaults to 127.0.0.1 which
  # prevents the ClusterIP service from routing traffic to the pod.
  config: |
    [mysqld]
    datadir                 = /var/lib/mysql
    bind-address            = 0.0.0.0
    character-set-server    = utf8mb4
    collation-server        = utf8mb4_unicode_ci
    default_authentication_plugin = mysql_native_password

  persistence:
    enabled: true
    storageClass: "harvester-longhorn"
    accessMode: ReadWriteOnce
    size: 8Gi
    # -- Annotations for the MySQL PVC.
    annotations: {}

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  # -- Security context for the MySQL container (non-root).
  securityContext:
    runAsNonRoot: true
    runAsUser: 65532
    runAsGroup: 65532
    readOnlyRootFilesystem: false
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

  # -- Pod-level security context for MySQL.
  # fsGroup causes Kubernetes to chown the volume to this GID on mount.
  # This works for most CSI drivers (including Longhorn) but is ignored by NFS.
  # The fix-data-dir-permissions init container handles NFS and any other
  # storage that doesn't honour fsGroup.
  podSecurityContext:
    fsGroup: 65532

  # -- Additional environment variables for MySQL.
  extraEnv: []

  # -- Node selector, tolerations, affinity for MySQL pod.
  nodeSelector: {}
  tolerations: []
  affinity: {}

  # -- MySQL service configuration.
  service:
    type: ClusterIP
    port: 3306

  # -- MySQL liveness/readiness probes.
  livenessProbe:
    tcpSocket:
      port: 3306
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  readinessProbe:
    tcpSocket:
      port: 3306
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

  # -- Pod disruption budget for MySQL.
  podDisruptionBudget:
    enabled: false
    minAvailable: 1

# =============================================================================
# External Database (use when mysql.enabled=false)
# =============================================================================
externalDatabase:
  # -- Set to "mariadb" or "mysql" when mysql.enabled=false.
  type: mysql
  host: ""
  port: 3306
  database: "uptimekuma"
  username: "uptimekuma"
  password: ""
  # -- Existing secret with key "db-password".
  existingSecret: ""

# =============================================================================
# Uptime Kuma Service
# =============================================================================
service:
  type: ClusterIP
  port: 3001
  # -- Annotations for the Service resource.
  annotations: {}

# =============================================================================
# Ingress
# =============================================================================
ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # cert-manager.io/cluster-issuer: letsencrypt-prod
    # nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    # nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  hosts:
    - host: uptime-kuma.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  # - secretName: uptime-kuma-tls
  #   hosts:
  #     - uptime-kuma.example.com

# =============================================================================
# Persistence for Uptime Kuma
# =============================================================================
persistence:
  enabled: true
  storageClass: "harvester-longhorn"
  accessMode: ReadWriteOnce
  size: 5Gi
  annotations: {}
  # -- Use an existing PVC instead of creating a new one.
  existingClaim: ""

# =============================================================================
# Resource Limits & Requests
# =============================================================================
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# =============================================================================
# Security Contexts
# =============================================================================
# -- Security context for the Uptime Kuma container.
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  readOnlyRootFilesystem: false
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# -- Pod-level security context for Uptime Kuma.
podSecurityContext:
  fsGroup: 1000

# =============================================================================
# Probes
# =============================================================================
livenessProbe:
  httpGet:
    path: /
    port: 3001
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 5

readinessProbe:
  httpGet:
    path: /
    port: 3001
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /
    port: 3001
  initialDelaySeconds: 15
  periodSeconds: 10
  failureThreshold: 30

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  annotations: {}
  name: ""
  automountServiceAccountToken: false

# =============================================================================
# Pod Settings
# =============================================================================
podAnnotations: {}
podLabels: {}

nodeSelector: {}
tolerations: []
affinity: {}

# -- Topology spread constraints for high availability.
topologySpreadConstraints: []

# -- Additional environment variables for Uptime Kuma.
extraEnv: []
# - name: UPTIME_KUMA_DISABLE_FRAME_SAMEORIGIN
#   value: "0"

# -- Additional volumes to mount.
extraVolumes: []
extraVolumeMounts: []

# =============================================================================
# Pod Disruption Budget
# =============================================================================
podDisruptionBudget:
  enabled: false
  minAvailable: 1

# =============================================================================
# Horizontal Pod Autoscaler
# NOTE: Uptime Kuma is stateful — HPA is defined here for completeness,
# but should remain disabled unless you understand the implications.
# =============================================================================
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 1
  targetCPUUtilizationPercentage: 80

# =============================================================================
# Network Policy
# =============================================================================
networkPolicy:
  # -- When enabled, restricts ingress/egress to only what is needed.
  enabled: false
  # -- Additional ingress rules beyond the defaults.
  additionalIngressRules: []
  # -- Additional egress rules beyond the defaults.
  additionalEgressRules: []

# =============================================================================
# Prometheus Metrics (mysqld-exporter sidecar)
# =============================================================================
metrics:
  enabled: false
  image:
    repository: dhi.io/mysqld-exporter
    tag: "0.17"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 50m
      memory: 32Mi
    limits:
      cpu: 200m
      memory: 64Mi
  serviceMonitor:
    enabled: false
    namespace: ""
    interval: 30s
    scrapeTimeout: 10s
    labels: {}
